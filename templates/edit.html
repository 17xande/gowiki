{{define "head"}}
  <title>SCMS|Edit {{.page.Title}}</title>
  <link rel="stylesheet" href="/public/dependencies/css/quill.snow.css">
{{end}}

{{define "body"}}
<form id="frmContent" action="/save/{{.page.ID.Hex}}" method="POST">
  <h1>Editing <input id="txtTitle" name="title" type="text" value="{{.page.Title}}"></h1>
  <div id="divQuill">{{.body}}</div>
  <input id="hdnBody" type="hidden" name="body">
  <input id="btnSave" type="submit" value="Save">
  <button id="btnCancel">Cancel</button>
  <div>
    <h3>Permissions:</h3>
    <label for="numLevel">Level:</label>
    <input id="numLevel" name="level" type="number" value="{{.page.Level}}">
    <input id="hdnPermissions" type="hidden" name="permissions">
  </div>
</form>
<h4>User Override:</h4>
<ul id="ulPermissions">
  {{range $index, $user := .users}}
    <label>{{$user.Name}}:<input type="checkbox" data-user-id="{{$user.ID.Hex}}"></label>
  {{end}}
</ul>
{{end}}

{{define "scripts"}}
  <script src="/public/dependencies/js/quill.min.js"></script>
  <script>
    let quill = new Quill('#divQuill', {
      placeholder: "Enter text here",
      theme: 'snow'
    });

    let hdnBody = document.getElementById("hdnBody");
    let btnCancel = document.getElementById("btnCancel");
    let id = window.location.pathname.slice(window.location.pathname.lastIndexOf('/'));

    // redirect to the view page
    $(btnCancel).on("click", function() {
      if (id == "/") {
        window.location.href = "/";
      } else {        
        window.location.href = "/view" + id;
      }
      return false
    });

    $("#frmContent").submit(function() {
      hdnBody.value = quill.container.children[0].innerHTML;
      csvChecked = $("#ulPermissions")
        .find("input:checked")
        .map((index, element) => element.getAttribute("data-user-id"))
        .get()
        .join();

      hdnPermissions.value = csvChecked

      return true;
    });
  </script>
{{end}}